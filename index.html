<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel資料選擇器 - 每日單一紀錄選取</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        h2 {
            color: #34495e;
            margin: 25px 0 15px 0;
        }

        .upload-section, .selection-section, .result-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .file-input {
            margin: 15px 0;
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
            background-color: #fff;
        }

        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .date-navigation {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-filter {
            margin: 15px 0;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            width: 200px;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: white;
        }

        .records-table th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .records-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .records-table tr:hover {
            background-color: #f0f7ff;
        }

        .selected-row {
            background-color: #d4edda !important;
        }

        .date-group {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fff;
        }

        .date-header {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selection-count {
            background-color: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .record-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-item:hover {
            background-color: #f0f7ff;
        }

        .record-item.selected {
            background-color: #d4edda;
            border-color: #27ae60;
        }

        .record-time {
            font-weight: bold;
            color: #2c3e50;
            min-width: 80px;
        }

        .record-desc {
            flex-grow: 1;
            margin: 0 15px;
            color: #34495e;
        }

        .record-hours {
            color: #e74c3c;
            font-weight: bold;
            min-width: 60px;
            text-align: right;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            color: #e74c3c;
            padding: 15px;
            background-color: #ffeaea;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #e74c3c;
        }

        .success {
            color: #27ae60;
            padding: 15px;
            background-color: #eafaf1;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #27ae60;
        }

        .export-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .summary {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }

        .summary h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .date-navigation {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-filter {
                width: 100%;
            }
            
            .record-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .record-desc {
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Excel資料選擇器 - 每日單一紀錄選取</h1>
        
        <!-- 檔案上傳區 -->
        <div class="upload-section">
            <h2>1. 上傳Excel檔案</h2>
            <p>請上傳您的Excel檔案（格式應包含HR_CD, ACTUAL_START_DT等欄位）</p>
            <input type="file" id="excelFile" class="file-input" accept=".xlsx, .xls">
            <button id="loadFileBtn" class="btn">載入檔案</button>
        </div>

        <!-- 資料選擇區 -->
        <div id="selectionSection" class="selection-section hidden">
            <h2>2. 選擇每日所需資料</h2>
            <p>請為每一天選擇一條您需要的紀錄。每一天必須且只能選擇一筆。</p>
            
            <div class="selection-controls">
                <div class="date-navigation">
                    <button id="prevDateBtn" class="btn">← 上一天</button>
                    <input type="date" id="dateFilter" class="date-filter">
                    <button id="nextDateBtn" class="btn">下一天 →</button>
                </div>
                <div>
                    <span id="currentDateDisplay"></span>
                    <button id="markAllBtn" class="btn">標記已選擇日期</button>
                </div>
            </div>

            <div class="summary">
                <h3>選擇進度</h3>
                <div id="selectionProgress">已選擇: <span id="selectedCount">0</span> / <span id="totalDates">0</span> 天</div>
                <div id="completionStatus" class="hidden success">✓ 所有日期都已選擇完成！</div>
            </div>

            <div id="recordsContainer">
                <!-- 這裡會動態載入每天的紀錄 -->
            </div>

            <div class="export-controls">
                <button id="showAllBtn" class="btn">顯示所有日期的選擇</button>
                <button id="exportBtn" class="btn btn-success" disabled>匯出選擇的資料</button>
                <button id="resetBtn" class="btn btn-danger">重新開始</button>
            </div>
        </div>

        <!-- 結果顯示區 -->
        <div id="resultSection" class="result-section hidden">
            <h2>3. 已選擇的資料</h2>
            <div id="selectedDataContainer"></div>
            <div class="export-controls">
                <button id="backToSelectionBtn" class="btn">返回選擇</button>
                <button id="downloadExcelBtn" class="btn btn-success">下載Excel檔案</button>
                <button id="downloadCSVBtn" class="btn">下載CSV檔案</button>
                <button id="copyToClipboardBtn" class="btn">複製到剪貼簿</button>
            </div>
        </div>
    </div>

    <!-- 使用 SheetJS (xlsx) 處理 Excel 檔案 -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // 全域變數
        let rawData = [];
        let selectedData = new Map(); // 使用Map來儲存選擇的資料，key為日期，value為選擇的資料行
        let dates = [];
        let currentDateIndex = 0;

        // DOM 元素
        const excelFileInput = document.getElementById('excelFile');
        const loadFileBtn = document.getElementById('loadFileBtn');
        const selectionSection = document.getElementById('selectionSection');
        const resultSection = document.getElementById('resultSection');
        const recordsContainer = document.getElementById('recordsContainer');
        const selectedDataContainer = document.getElementById('selectedDataContainer');
        const dateFilter = document.getElementById('dateFilter');
        const prevDateBtn = document.getElementById('prevDateBtn');
        const nextDateBtn = document.getElementById('nextDateBtn');
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const markAllBtn = document.getElementById('markAllBtn');
        const showAllBtn = document.getElementById('showAllBtn');
        const exportBtn = document.getElementById('exportBtn');
        const resetBtn = document.getElementById('resetBtn');
        const backToSelectionBtn = document.getElementById('backToSelectionBtn');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');
        const downloadCSVBtn = document.getElementById('downloadCSVBtn');
        const copyToClipboardBtn = document.getElementById('copyToClipboardBtn');
        const selectedCountElement = document.getElementById('selectedCount');
        const totalDatesElement = document.getElementById('totalDates');
        const completionStatus = document.getElementById('completionStatus');

        // 載入檔案
        loadFileBtn.addEventListener('click', loadExcelFile);

        // 日期導航
        prevDateBtn.addEventListener('click', () => navigateDate(-1));
        nextDateBtn.addEventListener('click', () => navigateDate(1));
        dateFilter.addEventListener('change', filterByDate);

        // 按鈕事件
        markAllBtn.addEventListener('click', markSelectedDates);
        showAllBtn.addEventListener('click', showAllSelections);
        exportBtn.addEventListener('click', exportSelectedData);
        resetBtn.addEventListener('click', resetAll);
        backToSelectionBtn.addEventListener('click', backToSelection);
        downloadExcelBtn.addEventListener('click', downloadExcel);
        downloadCSVBtn.addEventListener('click', downloadCSV);
        copyToClipboardBtn.addEventListener('click', copyToClipboard);

        // 載入Excel檔案
        function loadExcelFile() {
            const file = excelFileInput.files[0];
            if (!file) {
                alert('請選擇一個Excel檔案');
                return;
            }

            showLoading('正在讀取Excel檔案...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 讀取第一個工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 將工作表轉換為JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // 處理資料
                    processExcelData(jsonData);
                    
                    selectionSection.classList.remove('hidden');
                } catch (error) {
                    console.error('讀取檔案錯誤:', error);
                    showError('讀取檔案失敗，請確認檔案格式正確');
                }
            };
            
            reader.onerror = function() {
                showError('讀取檔案失敗');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 處理Excel資料
        function processExcelData(jsonData) {
            if (jsonData.length < 2) {
                showError('檔案沒有足夠的資料');
                return;
            }

            // 取得表頭
            const headers = jsonData[0];
            
            // 找出需要的欄位索引
            const startDateIndex = headers.indexOf('ACTUAL_START_DT');
            const actualHrIndex = headers.indexOf('ACTUAL_HR');
            const acRegCdIndex = headers.indexOf('AC_REG_CD');
            const taskBarcodeIndex = headers.indexOf('TASK_BARCODE');
            const taskDescIndex = headers.indexOf('TASK_DESC');

            // 檢查必要欄位是否存在
            if (startDateIndex === -1) {
                showError('找不到 ACTUAL_START_DT 欄位');
                return;
            }

            // 處理每一行資料
            rawData = [];
            const dateSet = new Set();

            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row[startDateIndex]) continue;

                // 解析日期時間
                const dateTimeStr = row[startDateIndex];
                let dateObj;
                
                if (dateTimeStr instanceof Date) {
                    dateObj = dateTimeStr;
                } else if (typeof dateTimeStr === 'string') {
                    // 嘗試多種日期格式
                    dateObj = new Date(dateTimeStr);
                    if (isNaN(dateObj.getTime())) {
                        // 嘗試其他格式
                        const parts = dateTimeStr.split(/[/\s:-]/);
                        if (parts.length >= 3) {
                            dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                        }
                    }
                }

                if (!dateObj || isNaN(dateObj.getTime())) {
                    console.warn('無法解析日期:', dateTimeStr);
                    continue;
                }

                // 格式化日期 (YYYY-MM-DD)
                const dateOnly = dateObj.toISOString().split('T')[0];
                const timeOnly = dateObj.toTimeString().split(' ')[0];
                
                // 準備資料物件
                const dataObj = {
                    originalIndex: i - 1, // 原始索引（排除表頭）
                    date: dateOnly,
                    time: timeOnly,
                    actualHr: actualHrIndex !== -1 ? row[actualHrIndex] : '',
                    acRegCd: acRegCdIndex !== -1 ? row[acRegCdIndex] : '',
                    taskBarcode: taskBarcodeIndex !== -1 ? row[taskBarcodeIndex] : '',
                    taskDesc: taskDescIndex !== -1 ? row[taskDescIndex] : '無描述'
                };

                rawData.push(dataObj);
                dateSet.add(dateOnly);
            }

            // 取得日期列表並排序
            dates = Array.from(dateSet).sort();
            totalDatesElement.textContent = dates.length;
            
            // 顯示第一個日期的資料
            if (dates.length > 0) {
                currentDateIndex = 0;
                displayRecordsForDate(dates[0]);
                updateDateNavigation();
            } else {
                showError('檔案中沒有有效的日期資料');
            }
        }

        // 顯示指定日期的紀錄
        function displayRecordsForDate(date) {
            recordsContainer.innerHTML = '';
            currentDateDisplay.textContent = `當前日期: ${formatDateDisplay(date)}`;
            
            // 取得該日期的所有紀錄
            const dateRecords = rawData.filter(record => record.date === date);
            
            if (dateRecords.length === 0) {
                recordsContainer.innerHTML = '<div class="error">此日期沒有資料</div>';
                return;
            }

            // 建立日期群組
            const dateGroup = document.createElement('div');
            dateGroup.className = 'date-group';
            
            const dateHeader = document.createElement('div');
            dateHeader.className = 'date-header';
            dateHeader.innerHTML = `
                <span>${formatDateDisplay(date)} (${dateRecords.length} 筆紀錄)</span>
                <span id="selectionStatus_${date}" class="selection-count">
                    ${selectedData.has(date) ? '已選擇' : '未選擇'}
                </span>
            `;
            
            dateGroup.appendChild(dateHeader);
            
            // 顯示每一筆紀錄
            dateRecords.forEach(record => {
                const isSelected = selectedData.has(date) && 
                                 selectedData.get(date).originalIndex === record.originalIndex;
                
                const recordElement = document.createElement('div');
                recordElement.className = `record-item ${isSelected ? 'selected' : ''}`;
                recordElement.dataset.index = record.originalIndex;
                recordElement.dataset.date = record.date;
                
                recordElement.innerHTML = `
                    <div class="record-time">${record.time}</div>
                    <div class="record-desc">${record.taskDesc}</div>
                    <div class="record-hours">${record.actualHr} 小時</div>
                `;
                
                recordElement.addEventListener('click', () => selectRecord(record));
                
                dateGroup.appendChild(recordElement);
            });
            
            recordsContainer.appendChild(dateGroup);
            updateSelectionProgress();
        }

        // 選擇紀錄
        function selectRecord(record) {
            const date = record.date;
            selectedData.set(date, record);
            
            // 更新顯示
            const statusElement = document.getElementById(`selectionStatus_${date}`);
            if (statusElement) {
                statusElement.textContent = '已選擇';
                statusElement.style.backgroundColor = '#27ae60';
            }
            
            // 重新顯示當前日期的紀錄
            displayRecordsForDate(date);
            
            // 檢查是否所有日期都已選擇
            checkCompletion();
        }

        // 日期導航
        function navigateDate(direction) {
            currentDateIndex += direction;
            
            if (currentDateIndex < 0) {
                currentDateIndex = dates.length - 1;
            } else if (currentDateIndex >= dates.length) {
                currentDateIndex = 0;
            }
            
            displayRecordsForDate(dates[currentDateIndex]);
            updateDateNavigation();
        }

        // 過濾日期
        function filterByDate() {
            const selectedDate = dateFilter.value;
            if (!selectedDate) return;
            
            const index = dates.indexOf(selectedDate);
            if (index !== -1) {
                currentDateIndex = index;
                displayRecordsForDate(selectedDate);
                updateDateNavigation();
            } else {
                alert('選擇的日期沒有資料');
            }
        }

        // 更新日期導航
        function updateDateNavigation() {
            if (dates.length === 0) return;
            
            dateFilter.value = dates[currentDateIndex];
            currentDateDisplay.textContent = `當前日期: ${formatDateDisplay(dates[currentDateIndex])} (${currentDateIndex + 1}/${dates.length})`;
        }

        // 標記已選擇日期
        function markSelectedDates() {
            const dateGroups = document.querySelectorAll('.date-group');
            dateGroups.forEach(group => {
                const date = group.querySelector('.record-item')?.dataset.date;
                if (date && selectedData.has(date)) {
                    group.style.borderColor = '#27ae60';
                    group.style.backgroundColor = '#f0fff4';
                }
            });
        }

        // 顯示所有選擇
        function showAllSelections() {
            const allSelections = Array.from(selectedData.values());
            
            if (allSelections.length === 0) {
                alert('請先選擇資料');
                return;
            }
            
            // 建立表格顯示所有選擇的資料
            let html = `
                <div class="summary">
                    <h3>總共選擇了 ${allSelections.length} 天的資料</h3>
                    <p>以下為您選擇的資料：</p>
                </div>
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>時間</th>
                            <th>實際工時</th>
                            <th>AC_REG_CD</th>
                            <th>任務條碼</th>
                            <th>任務描述</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // 按日期排序
            allSelections.sort((a, b) => a.date.localeCompare(b.date));
            
            allSelections.forEach(record => {
                html += `
                    <tr>
                        <td>${formatDateDisplay(record.date)}</td>
                        <td>${record.time}</td>
                        <td>${record.actualHr}</td>
                        <td>${record.acRegCd}</td>
                        <td>${record.taskBarcode}</td>
                        <td>${record.taskDesc}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            selectedDataContainer.innerHTML = html;
            
            // 切換到結果區
            selectionSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
        }

        // 匯出選擇的資料
        function exportSelectedData() {
            if (selectedData.size !== dates.length) {
                const confirmExport = confirm(`您還有 ${dates.length - selectedData.size} 天未選擇。是否確定要匯出？`);
                if (!confirmExport) return;
            }
            
            showAllSelections();
        }

        // 下載Excel
        function downloadExcel() {
            const allSelections = Array.from(selectedData.values());
            if (allSelections.length === 0) {
                alert('沒有資料可以下載');
                return;
            }
            
            // 準備工作表資料
            const wsData = [
                ['日期', '時間', '實際工時', 'AC_REG_CD', '任務條碼', '任務描述']
            ];
            
            // 按日期排序
            allSelections.sort((a, b) => a.date.localeCompare(b.date));
            
            allSelections.forEach(record => {
                wsData.push([
                    formatDateDisplay(record.date),
                    record.time,
                    record.actualHr,
                    record.acRegCd,
                    record.taskBarcode,
                    record.taskDesc
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '選擇的資料');
            
            // 下載檔案
            XLSX.writeFile(wb, '選擇的資料.xlsx');
        }

        // 下載CSV
        function downloadCSV() {
            const allSelections = Array.from(selectedData.values());
            if (allSelections.length === 0) {
                alert('沒有資料可以下載');
                return;
            }
            
            // 建立CSV內容
            let csvContent = '日期,時間,實際工時,AC_REG_CD,任務條碼,任務描述\n';
            
            // 按日期排序
            allSelections.sort((a, b) => a.date.localeCompare(b.date));
            
            allSelections.forEach(record => {
                csvContent += `"${formatDateDisplay(record.date)}","${record.time}","${record.actualHr}","${record.acRegCd}","${record.taskBarcode}","${record.taskDesc}"\n`;
            });
            
            // 建立下載連結
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = '選擇的資料.csv';
            link.click();
        }

        // 複製到剪貼簿
        function copyToClipboard() {
            const allSelections = Array.from(selectedData.values());
            if (allSelections.length === 0) {
                alert('沒有資料可以複製');
                return;
            }
            
            // 建立文字內容
            let textContent = '日期\t時間\t實際工時\tAC_REG_CD\t任務條碼\t任務描述\n';
            
            // 按日期排序
            allSelections.sort((a, b) => a.date.localeCompare(b.date));
            
            allSelections.forEach(record => {
                textContent += `${formatDateDisplay(record.date)}\t${record.time}\t${record.actualHr}\t${record.acRegCd}\t${record.taskBarcode}\t${record.taskDesc}\n`;
            });
            
            // 複製到剪貼簿
            navigator.clipboard.writeText(textContent)
                .then(() => alert('已複製到剪貼簿！'))
                .catch(err => alert('複製失敗: ' + err));
        }

        // 返回選擇畫面
        function backToSelection() {
            resultSection.classList.add('hidden');
            selectionSection.classList.remove('hidden');
        }

        // 重置所有
        function resetAll() {
            if (confirm('確定要重新開始嗎？所有選擇的資料將會遺失。')) {
                selectedData.clear();
                rawData = [];
                dates = [];
                currentDateIndex = 0;
                
                excelFileInput.value = '';
                recordsContainer.innerHTML = '';
                selectedDataContainer.innerHTML = '';
                
                selectionSection.classList.add('hidden');
                resultSection.classList.add('hidden');
                
                exportBtn.disabled = true;
                updateSelectionProgress();
            }
        }

        // 更新選擇進度
        function updateSelectionProgress() {
            selectedCountElement.textContent = selectedData.size;
            
            if (selectedData.size === dates.length && dates.length > 0) {
                completionStatus.classList.remove('hidden');
                exportBtn.disabled = false;
            } else {
                completionStatus.classList.add('hidden');
                exportBtn.disabled = true;
            }
        }

        // 檢查是否完成所有選擇
        function checkCompletion() {
            updateSelectionProgress();
            
            if (selectedData.size === dates.length && dates.length > 0) {
                setTimeout(() => {
                    if (confirm('所有日期都已選擇完成！是否要顯示結果？')) {
                        exportSelectedData();
                    }
                }, 500);
            }
        }

        // 格式化日期顯示
        function formatDateDisplay(dateStr) {
            const date = new Date(dateStr);
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        }

        // 顯示載入中
        function showLoading(message) {
            recordsContainer.innerHTML = `<div class="loading">${message}</div>`;
        }

        // 顯示錯誤
        function showError(message) {
            recordsContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        // 初始化日期過濾器
        function initializeDateFilter() {
            const today = new Date();
            dateFilter.value = today.toISOString().split('T')[0];
            dateFilter.min = '2023-01-01';
            dateFilter.max = '2025-12-31';
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', initializeDateFilter);
    </script>
</body>
</html>
