<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>180經歷選擇器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .description {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0 25px 0;
            border-left: 4px solid #3498db;
        }

        .description h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .description ol {
            padding-left: 20px;
            margin-bottom: 10px;
        }

        .description li {
            margin-bottom: 8px;
        }

        h2 {
            color: #34495e;
            margin: 25px 0 15px 0;
        }

        .upload-section, .selection-section, .result-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .file-input {
            margin: 15px 0;
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
            background-color: #fff;
        }

        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: #f39c12;
        }

        .btn-warning:hover {
            background-color: #d68910;
        }

        .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .date-navigation {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-filter {
            margin: 15px 0;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            width: 200px;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: white;
        }

        .records-table th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
            cursor: pointer;
        }

        .records-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
        }

        .records-table tr:hover {
            background-color: #f0f7ff;
        }

        .selected-row {
            background-color: #d4edda !important;
        }

        .date-group {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fff;
        }

        .date-header {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selection-count {
            background-color: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }

        .record-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-item:hover {
            background-color: #f0f7ff;
        }

        .record-item.selected {
            background-color: #d4edda;
            border-color: #27ae60;
        }

        .record-time {
            font-weight: bold;
            color: #2c3e50;
            min-width: 80px;
        }

        .record-desc {
            flex-grow: 1;
            margin: 0 15px;
            color: #34495e;
        }

        .record-hours {
            color: #e74c3c;
            font-weight: bold;
            min-width: 60px;
            text-align: right;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            color: #e74c3c;
            padding: 15px;
            background-color: #ffeaea;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #e74c3c;
        }

        .success {
            color: #27ae60;
            padding: 15px;
            background-color: #eafaf1;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #27ae60;
        }

        .export-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .summary {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }

        .summary h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .tlb-dd {
            color: #e74c3c;
            font-weight: bold;
        }

        .calendar-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .calendar-day:hover {
            background-color: #f0f7ff;
        }

        .calendar-day.has-data {
            background-color: #3498db;
            color: white;
        }

        .calendar-day.has-data.selected-date {
            background-color: #27ae60;
        }

        .calendar-day.current-date {
            border: 2px solid #e74c3c;
            box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
        }

        .calendar-day.empty {
            background-color: #f5f5f5;
            cursor: default;
        }

        .calendar-day-header {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .record-acreg {
            font-weight: bold;
            color: #2c3e50;
            min-width: 100px;
            text-align: center;
        }

        .stats-container {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #f39c12;
        }

        .stats-container h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .stat-item {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .date-navigation {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-filter {
                width: 100%;
            }
            
            .record-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .record-desc {
                margin: 5px 0;
            }
            
            .record-acreg {
                margin: 5px 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>180經歷選擇器</h1>
        
        <!-- 說明區塊 -->
        <div class="description">
            <h3>說明 :</h3>
            <ol>
                <li>先進入到 <a href="https://cksweb01/MH/ERP/Laborquery.aspx" target="_blank">https://cksweb01/MH/ERP/Laborquery.aspx</a> 抓取需要的時間段經歷</li>
                <li>再把資料點選上傳</li>
            </ol>
        </div>

        <!-- 檔案上傳區 -->
        <div class="upload-section">
            <h2>2. 上傳Excel檔案</h2>
            <p>請上傳您的Excel檔案（格式應包含HR_CD, ACTUAL_START_DT等欄位）</p>
            <input type="file" id="excelFile" class="file-input" accept=".xlsx, .xls">
        </div>

        <!-- 資料選擇區 -->
        <div id="selectionSection" class="selection-section hidden">
            <h2>3. 選擇每日所需資料</h2>
            <p>請為每一天選擇一條您需要的紀錄。每一天必須且只能選擇一筆。</p>
            
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="prevMonthBtn" class="btn">← 上個月</button>
                    <h3 id="currentMonthDisplay"></h3>
                    <button id="nextMonthBtn" class="btn">下個月 →</button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- 日曆將在這裡動態生成 -->
                </div>
            </div>
            
            <div class="selection-controls">
                <div class="date-navigation">
                    <button id="prevDateBtn" class="btn">← 上一天</button>
                    <input type="date" id="dateFilter" class="date-filter" list="dateList">
                    <datalist id="dateList"></datalist>
                    <button id="nextDateBtn" class="btn">下一天 →</button>
                </div>
                <div>
                    <span id="currentDateDisplay"></span>
                    <button id="autoSelectBtn" class="btn btn-warning">自動選擇</button>
                </div>
            </div>

            <div class="summary">
                <h3>選擇進度</h3>
                <div id="selectionProgress">已選擇: <span id="selectedCount">0</span> / <span id="totalDates">0</span> 天</div>
                <div id="completionStatus" class="hidden success">✓ 所有日期都已選擇完成！</div>
            </div>

            <div id="recordsContainer">
                <!-- 這裡會動態載入每天的紀錄 -->
            </div>

            <div class="export-controls">
                <button id="exportBtn" class="btn btn-success">匯出選擇的資料</button>
                <button id="resetBtn" class="btn btn-danger">重新選擇</button>
            </div>
        </div>

        <!-- 結果顯示區 -->
        <div id="resultSection" class="result-section hidden">
            <h2>4. 已選擇的資料</h2>
            <div id="selectedDataContainer"></div>
            
            <!-- 統計區塊 -->
            <div id="statsContainer" class="stats-container hidden">
                <h3>統計資料</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="ddCount">0</div>
                        <div class="stat-label">包含 "DD" 字眼的紀錄</div>
                    </div>
                </div>
            </div>
            
            <div class="export-controls">
                <button id="backToSelectionBtn" class="btn">返回選擇</button>
                <button id="downloadExcelBtn" class="btn btn-success">下載Excel檔案</button>
                <button id="downloadCSVBtn" class="btn">下載CSV檔案</button>
                <button id="copyToClipboardBtn" class="btn">複製到剪貼簿</button>
            </div>
        </div>
    </div>

    <!-- 使用 SheetJS (xlsx) 處理 Excel 檔案 -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
        // 全域變數
        let rawData = [];
        let selectedData = new Map(); // 使用Map來儲存選擇的資料，key為日期，value為選擇的資料行
        let dates = [];
        let currentDateIndex = 0;
        let minDate = null;
        let maxDate = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // 關鍵字優先順序（從高到低）
        const keywordPriority = [
            'TLB DD',
            'DD',
            'DAILY',
            'DY',
            'WEEKLY',
            'WK',
            'MAIN WHEEL TIRE',
            'TIRE',
            'OXY',
            'OXYGEN'
        ];

        // DOM 元素
        const excelFileInput = document.getElementById('excelFile');
        const selectionSection = document.getElementById('selectionSection');
        const resultSection = document.getElementById('resultSection');
        const recordsContainer = document.getElementById('recordsContainer');
        const selectedDataContainer = document.getElementById('selectedDataContainer');
        const statsContainer = document.getElementById('statsContainer');
        const ddCountElement = document.getElementById('ddCount');
        const dateFilter = document.getElementById('dateFilter');
        const dateList = document.getElementById('dateList');
        const prevDateBtn = document.getElementById('prevDateBtn');
        const nextDateBtn = document.getElementById('nextDateBtn');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const currentMonthDisplay = document.getElementById('currentMonthDisplay');
        const autoSelectBtn = document.getElementById('autoSelectBtn');
        const exportBtn = document.getElementById('exportBtn');
        const resetBtn = document.getElementById('resetBtn');
        const backToSelectionBtn = document.getElementById('backToSelectionBtn');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');
        const downloadCSVBtn = document.getElementById('downloadCSVBtn');
        const copyToClipboardBtn = document.getElementById('copyToClipboardBtn');
        const selectedCountElement = document.getElementById('selectedCount');
        const totalDatesElement = document.getElementById('totalDates');
        const completionStatus = document.getElementById('completionStatus');
        const calendarGrid = document.getElementById('calendarGrid');

        // 事件監聽
        excelFileInput.addEventListener('change', loadExcelFile);
        prevDateBtn.addEventListener('click', () => navigateDate(-1));
        nextDateBtn.addEventListener('click', () => navigateDate(1));
        prevMonthBtn.addEventListener('click', () => navigateMonth(-1));
        nextMonthBtn.addEventListener('click', () => navigateMonth(1));
        dateFilter.addEventListener('change', filterByDate);
        autoSelectBtn.addEventListener('click', autoSelectRecords);
        exportBtn.addEventListener('click', exportSelectedData);
        resetBtn.addEventListener('click', resetSelections);
        backToSelectionBtn.addEventListener('click', backToSelection);
        downloadExcelBtn.addEventListener('click', downloadExcel);
        downloadCSVBtn.addEventListener('click', downloadCSV);
        copyToClipboardBtn.addEventListener('click', copyToClipboard);

        // 自動載入Excel檔案
        function loadExcelFile() {
            const file = excelFileInput.files[0];
            if (!file) {
                alert('請選擇一個Excel檔案');
                return;
            }

            showLoading('正在讀取Excel檔案...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true, // 啟用日期解析
                        cellStyles: true // 保留單元格樣式
                    });
                    
                    // 讀取第一個工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 將工作表轉換為JSON，保留日期格式
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        raw: false, // 獲取原始值，不是公式
                        dateNF: 'yyyy-mm-dd' // 日期格式
                    });
                    
                    // 處理資料
                    processExcelData(jsonData);
                    
                    // 顯示選擇區
                    selectionSection.classList.remove('hidden');
                } catch (error) {
                    console.error('讀取檔案錯誤:', error);
                    showError('讀取檔案失敗，請確認檔案格式正確');
                }
            };
            
            reader.onerror = function() {
                showError('讀取檔案失敗');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 處理Excel資料
        function processExcelData(jsonData) {
            if (jsonData.length < 2) {
                showError('檔案沒有足夠的資料');
                return;
            }

            // 取得表頭
            const headers = jsonData[0];
            
            // 找出需要的欄位索引
            const startDateIndex = headers.findIndex(h => 
                h && h.toString().toUpperCase().includes('ACTUAL_START_DT')
            );
            const actualHrIndex = headers.findIndex(h => 
                h && h.toString().toUpperCase().includes('ACTUAL_HR')
            );
            const acRegCdIndex = headers.findIndex(h => 
                h && h.toString().toUpperCase().includes('AC_REG_CD')
            );
            const taskBarcodeIndex = headers.findIndex(h => 
                h && h.toString().toUpperCase().includes('TASK_BARCODE')
            );
            const taskDescIndex = headers.findIndex(h => 
                h && h.toString().toUpperCase().includes('TASK_DESC')
            );

            // 檢查必要欄位是否存在
            if (startDateIndex === -1) {
                showError('找不到 ACTUAL_START_DT 欄位');
                return;
            }

            // 處理每一行資料
            rawData = [];
            const dateSet = new Set();
            minDate = null;
            maxDate = null;

            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row[startDateIndex] === undefined || row[startDateIndex] === null) continue;

                // 解析日期時間
                const dateTimeStr = row[startDateIndex];
                let dateObj;
                
                // 嘗試解析日期
                dateObj = parseDate(dateTimeStr);
                
                if (!dateObj || isNaN(dateObj.getTime())) {
                    console.warn('無法解析日期:', dateTimeStr);
                    continue;
                }

                // 格式化日期 (YYYY-MM-DD)
                const dateOnly = formatDate(dateObj);
                const timeOnly = formatTime(dateObj);
                
                // 準備資料物件 - 保持原始資料不變
                const dataObj = {
                    originalIndex: i - 1,
                    date: dateOnly,
                    time: timeOnly,
                    actualHr: actualHrIndex !== -1 ? 
                        (row[actualHrIndex] ? row[actualHrIndex].toString() : '') : '',
                    acRegCd: acRegCdIndex !== -1 ? 
                        (row[acRegCdIndex] ? row[acRegCdIndex].toString() : '') : '',
                    taskBarcode: taskBarcodeIndex !== -1 ? 
                        (row[taskBarcodeIndex] ? row[taskBarcodeIndex].toString() : '') : '',
                    taskDesc: taskDescIndex !== -1 ? 
                        (row[taskDescIndex] ? row[taskDescIndex].toString() : '無描述') : '無描述',
                    rawTaskDesc: taskDescIndex !== -1 ? 
                        (row[taskDescIndex] ? row[taskDescIndex].toString() : '無描述') : '無描述'
                };

                rawData.push(dataObj);
                dateSet.add(dateOnly);
                
                // 更新最小和最大日期
                if (!minDate || dateOnly < minDate) {
                    minDate = dateOnly;
                }
                if (!maxDate || dateOnly > maxDate) {
                    maxDate = dateOnly;
                }
            }

            // 取得日期列表並排序
            dates = Array.from(dateSet).sort();
            totalDatesElement.textContent = dates.length;
            
            // 更新日期列表
            updateDateList();
            
            // 設定初始月份為第一個日期的月份
            if (minDate) {
                const minDateObj = parseDateString(minDate);
                currentMonth = minDateObj.getMonth();
                currentYear = minDateObj.getFullYear();
            }
            
            // 更新日曆
            updateCalendar();
            
            // 顯示第一個日期的資料
            if (dates.length > 0) {
                currentDateIndex = 0;
                displayRecordsForDate(dates[currentDateIndex]);
                updateDateNavigation();
            } else {
                showError('檔案中沒有有效的日期資料');
            }
        }

        // 解析日期字串
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // 如果已經是 Date 物件
            if (dateStr instanceof Date) {
                return dateStr;
            }
            
            // 如果是數字（Excel 序列號）
            if (typeof dateStr === 'number') {
                // Excel 日期從 1900-01-01 開始
                const excelEpoch = new Date(1900, 0, 1);
                // Excel 有一個錯誤：它將 1900 年視為閏年，所以需要調整
                const days = Math.floor(dateStr);
                const ms = Math.round((dateStr - days) * 86400000);
                
                // 計算日期
                let date = new Date(excelEpoch);
                date.setDate(date.getDate() + days - 2); // 減去 2 天來修正 Excel 的錯誤
                date.setTime(date.getTime() + ms);
                
                return date;
            }
            
            // 如果是字串
            if (typeof dateStr === 'string') {
                // 移除可能的空格
                const cleanStr = dateStr.trim();
                
                // 嘗試多種日期格式
                let date = new Date(cleanStr);
                
                // 如果解析失敗，嘗試其他格式
                if (isNaN(date.getTime())) {
                    // 嘗試常見的 Excel 日期格式
                    const formats = [
                        /(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/, // YYYY-MM-DD 或 YYYY/MM/DD
                        /(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})/, // DD-MM-YYYY 或 DD/MM/YYYY
                        /(\d{4})(\d{2})(\d{2})/, // YYYYMMDD
                    ];
                    
                    for (const format of formats) {
                        const match = cleanStr.match(format);
                        if (match) {
                            if (match[1].length === 4) {
                                // YYYY-MM-DD 或 YYYYMMDD
                                date = new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
                            } else {
                                // DD-MM-YYYY
                                date = new Date(parseInt(match[3]), parseInt(match[2]) - 1, parseInt(match[1]));
                            }
                            
                            if (!isNaN(date.getTime())) {
                                return date;
                            }
                        }
                    }
                }
                
                return date;
            }
            
            return null;
        }

        // 解析日期字串 (YYYY-MM-DD)
        function parseDateString(dateStr) {
            const parts = dateStr.split('-');
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }

        // 格式化日期為 YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 格式化時間為 HH:MM:SS
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        // 更新日期列表
        function updateDateList() {
            dateList.innerHTML = '';
            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                dateList.appendChild(option);
            });
        }

        // 顯示指定日期的紀錄 - 修正版本，顯示原始內容
        function displayRecordsForDate(date) {
            recordsContainer.innerHTML = '';
            currentDateDisplay.textContent = `當前日期: ${formatDateDisplay(date)}`;
            
            // 取得該日期的所有紀錄
            const dateRecords = rawData.filter(record => record.date === date);
            
            if (dateRecords.length === 0) {
                recordsContainer.innerHTML = '<div class="error">此日期沒有資料</div>';
                return;
            }

            // 建立日期群組
            const dateGroup = document.createElement('div');
            dateGroup.className = 'date-group';
            
            const dateHeader = document.createElement('div');
            dateHeader.className = 'date-header';
            dateHeader.innerHTML = `
                <span>${formatDateDisplay(date)} (${dateRecords.length} 筆紀錄)</span>
                <span id="selectionStatus_${date}" class="selection-count">
                    ${selectedData.has(date) ? '已選擇' : '未選擇'}
                </span>
            `;
            
            dateGroup.appendChild(dateHeader);
            
            // 顯示每一筆紀錄
            dateRecords.forEach(record => {
                const isSelected = selectedData.has(date) && 
                                 selectedData.get(date).originalIndex === record.originalIndex;
                
                // 使用原始任務描述，但標記TLB和DD為紅字
                let taskDescHtml = highlightTLBDD(record.rawTaskDesc || record.taskDesc);
                
                const recordElement = document.createElement('div');
                recordElement.className = `record-item ${isSelected ? 'selected' : ''}`;
                recordElement.dataset.index = record.originalIndex;
                recordElement.dataset.date = record.date;
                
                recordElement.innerHTML = `
                    <div class="record-time">${record.time}</div>
                    <div class="record-acreg">${record.acRegCd || '無機號'}</div>
                    <div class="record-desc">${taskDescHtml}</div>
                    <div class="record-hours">${record.actualHr} 小時</div>
                `;
                
                recordElement.addEventListener('click', () => {
                    selectRecord(record);
                    // 選擇後自動跳到下一天
                    setTimeout(() => {
                        if (currentDateIndex < dates.length - 1) {
                            navigateDate(1);
                        } else {
                            // 如果已經是最後一天，檢查是否所有日期都已選擇
                            checkCompletion();
                        }
                    }, 300);
                });
                
                dateGroup.appendChild(recordElement);
            });
            
            recordsContainer.appendChild(dateGroup);
            updateSelectionProgress();
            
            // 更新日曆中的當前日期標記
            updateCalendar();
        }

        // 標記TLB和DD為紅字 - 修正版本，不會重複標記
        function highlightTLBDD(text) {
            if (!text) return text;
            
            // 創建一個副本來處理，不修改原始文字
            let result = text;
            
            // 先處理各種形式的TLB DD組合
            // 使用正則表達式匹配 TLB 和 DD 的各種組合
            // 但不重複標記已經標記過的內容
            
            // 先將 HTML 特殊字符轉義
            result = result.replace(/&/g, "&amp;")
                          .replace(/</g, "&lt;")
                          .replace(/>/g, "&gt;")
                          .replace(/"/g, "&quot;")
                          .replace(/'/g, "&#039;");
            
            // 處理 TLB-DD 形式
            result = result.replace(/(TLB-DD)/gi, '<span class="tlb-dd">$1</span>');
            
            // 處理 TLB DD 形式（一個或多個空格）
            result = result.replace(/(TLB\s+DD)/gi, '<span class="tlb-dd">$1</span>');
            
            // 處理單獨的 TLB（前面沒有標記過）
            result = result.replace(/(?<!<span class="tlb-dd">.*)TLB(?!.*<\/span>)/gi, '<span class="tlb-dd">TLB</span>');
            
            // 處理單獨的 DD（前面沒有標記過）
            result = result.replace(/(?<!<span class="tlb-dd">.*)\bDD\b(?!.*<\/span>)/gi, '<span class="tlb-dd">DD</span>');
            
            return result;
        }

        // 選擇紀錄
        function selectRecord(record) {
            const date = record.date;
            selectedData.set(date, record);
            
            // 更新顯示
            const statusElement = document.getElementById(`selectionStatus_${date}`);
            if (statusElement) {
                statusElement.textContent = '已選擇';
                statusElement.style.backgroundColor = '#27ae60';
            }
            
            // 重新顯示當前日期的紀錄
            displayRecordsForDate(date);
        }

        // 日期導航
        function navigateDate(direction) {
            currentDateIndex += direction;
            
            if (currentDateIndex < 0) {
                currentDateIndex = dates.length - 1;
            } else if (currentDateIndex >= dates.length) {
                currentDateIndex = 0;
            }
            
            // 檢查是否需要更新日曆月份
            const currentDate = parseDateString(dates[currentDateIndex]);
            if (currentDate.getMonth() !== currentMonth || currentDate.getFullYear() !== currentYear) {
                currentMonth = currentDate.getMonth();
                currentYear = currentDate.getFullYear();
                updateCalendar();
            }
            
            displayRecordsForDate(dates[currentDateIndex]);
            updateDateNavigation();
        }

        // 月份導航
        function navigateMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }

        // 過濾日期
        function filterByDate() {
            const selectedDate = dateFilter.value;
            if (!selectedDate) return;
            
            const index = dates.indexOf(selectedDate);
            if (index !== -1) {
                currentDateIndex = index;
                
                // 檢查是否需要更新日曆月份
                const dateObj = parseDateString(selectedDate);
                if (dateObj.getMonth() !== currentMonth || dateObj.getFullYear() !== currentYear) {
                    currentMonth = dateObj.getMonth();
                    currentYear = dateObj.getFullYear();
                    updateCalendar();
                }
                
                displayRecordsForDate(selectedDate);
                updateDateNavigation();
            } else {
                alert('選擇的日期沒有資料');
            }
        }

        // 更新日期導航
        function updateDateNavigation() {
            if (dates.length === 0) return;
            
            dateFilter.value = dates[currentDateIndex];
            currentDateDisplay.textContent = `當前日期: ${formatDateDisplay(dates[currentDateIndex])} (${currentDateIndex + 1}/${dates.length})`;
        }

        // 更新日曆 - 只顯示資料範圍內的月份
        function updateCalendar() {
            if (!minDate || !maxDate) return;
            
            // 限制月份範圍
            const minDateObj = parseDateString(minDate);
            const maxDateObj = parseDateString(maxDate);
            const minMonth = minDateObj.getMonth();
            const minYear = minDateObj.getFullYear();
            const maxMonth = maxDateObj.getMonth();
            const maxYear = maxDateObj.getFullYear();
            
            // 確保當前月份在範圍內
            const currentDateNum = currentYear * 12 + currentMonth;
            const minDateNum = minYear * 12 + minMonth;
            const maxDateNum = maxYear * 12 + maxMonth;
            
            if (currentDateNum < minDateNum) {
                currentMonth = minMonth;
                currentYear = minYear;
            } else if (currentDateNum > maxDateNum) {
                currentMonth = maxMonth;
                currentYear = maxYear;
            }
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const firstDayIndex = firstDay.getDay();
            
            // 更新月份顯示
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', 
                               '七月', '八月', '九月', '十月', '十一月', '十二月'];
            currentMonthDisplay.textContent = `${currentYear}年 ${monthNames[currentMonth]}`;
            
            // 清空日曆
            calendarGrid.innerHTML = '';
            
            // 添加星期標題
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            weekdays.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day-header';
                dayElement.textContent = day;
                calendarGrid.appendChild(dayElement);
            });
            
            // 添加空的日期格
            for (let i = 0; i < firstDayIndex; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyDay);
            }
            
            // 添加月份的每一天
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                dayElement.dataset.date = dateStr;
                
                // 檢查這一天是否有資料（在日期範圍內且有資料）
                if (dates.includes(dateStr)) {
                    dayElement.classList.add('has-data');
                    
                    // 檢查這一天是否已選擇
                    if (selectedData.has(dateStr)) {
                        dayElement.classList.add('selected-date');
                    }
                    
                    // 檢查是否為當前選擇的日期
                    if (dates[currentDateIndex] === dateStr) {
                        dayElement.classList.add('current-date');
                    }
                    
                    dayElement.addEventListener('click', () => {
                        const index = dates.indexOf(dateStr);
                        if (index !== -1) {
                            currentDateIndex = index;
                            displayRecordsForDate(dateStr);
                            updateDateNavigation();
                        }
                    });
                } else {
                    dayElement.classList.add('empty');
                }
                
                calendarGrid.appendChild(dayElement);
            }
            
            // 更新月份導航按鈕狀態
            prevMonthBtn.disabled = (currentYear * 12 + currentMonth) <= minDateNum;
            nextMonthBtn.disabled = (currentYear * 12 + currentMonth) >= maxDateNum;
        }

        // 自動選擇功能 - 按照邏輯選擇但不改變原始資料
        function autoSelectRecords() {
            if (dates.length === 0) {
                alert('沒有資料可以選擇');
                return;
            }
            
            if (!confirm('自動選擇將會根據優先順序為每個日期選擇一條紀錄，確定要執行嗎？')) {
                return;
            }
            
            // 記錄已選擇的天數
            let autoSelectedCount = 0;
            
            // 為每個日期選擇一條紀錄
            dates.forEach(date => {
                // 如果已經選擇了，跳過
                if (selectedData.has(date)) return;
                
                // 取得該日期的所有紀錄
                const dateRecords = rawData.filter(record => record.date === date);
                if (dateRecords.length === 0) return;
                
                // 根據優先順序選擇紀錄
                let bestRecord = null;
                let bestPriority = keywordPriority.length + 1; // 數字越小優先級越高
                
                dateRecords.forEach(record => {
                    // 取得這條紀錄的優先級
                    const priority = getRecordPriority(record.rawTaskDesc || record.taskDesc);
                    
                    // 如果找到優先級更高的紀錄，更新選擇
                    if (priority < bestPriority) {
                        bestPriority = priority;
                        bestRecord = record;
                    }
                });
                
                // 如果找到了紀錄，選擇它
                if (bestRecord) {
                    selectedData.set(date, bestRecord);
                    autoSelectedCount++;
                }
            });
            
            // 更新顯示
            if (dates.length > 0) {
                displayRecordsForDate(dates[currentDateIndex]);
                updateCalendar();
            }
            
            alert(`自動選擇完成！已選擇 ${autoSelectedCount} 天的資料。`);
        }

        // 計算紀錄的優先級 - 完全按照您的邏輯
        function getRecordPriority(taskDesc) {
            if (!taskDesc) return keywordPriority.length + 1;
            
            const upperDesc = taskDesc.toUpperCase();
            
            // 按照關鍵字優先順序檢查
            for (let i = 0; i < keywordPriority.length; i++) {
                const keyword = keywordPriority[i].toUpperCase();
                
                // 檢查是否包含關鍵字
                if (upperDesc.includes(keyword)) {
                    return i; // 數字越小優先級越高
                }
            }
            
            return keywordPriority.length + 1; // 沒有匹配關鍵字，最低優先級
        }

        // 匯出選擇的資料
        function exportSelectedData() {
            const allSelections = Array.from(selectedData.values());
            
            if (allSelections.length === 0) {
                alert('請先選擇至少一筆資料');
                return;
            }
            
            showAllSelections();
        }

        // 統計包含"DD"字眼的紀錄數量
        function countDDRecords() {
            const allSelections = Array.from(selectedData.values());
            let ddCount = 0;
            
            allSelections.forEach(record => {
                const taskDesc = (record.rawTaskDesc || record.taskDesc || '').toUpperCase();
                if (taskDesc.includes('DD')) {
                    ddCount++;
                }
            });
            
            return ddCount;
        }

        // 顯示所有選擇
        function showAllSelections() {
            const allSelections = Array.from(selectedData.values());
            
            // 建立表格顯示所有選擇的資料
            let html = `
                <div class="summary">
                    <h3>總共選擇了 ${allSelections.length} 天的資料</h3>
                    <p>點擊任一行可以重新選擇該日期的資料</p>
                </div>
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>時間</th>
                            <th>機號</th>
                            <th>實際工時</th>
                            <th>任務條碼</th>
                            <th>任務描述</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // 按日期排序
            allSelections.sort((a, b) => a.date.localeCompare(b.date));
            
            allSelections.forEach(record => {
                // 使用原始任務描述，不進行高亮處理
                let taskDescHtml = (record.rawTaskDesc || record.taskDesc || '')
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
                
                html += `
                    <tr data-date="${record.date}" data-index="${record.originalIndex}">
                        <td>${formatDateDisplay(record.date)}</td>
                        <td>${record.time}</td>
                        <td>${record.acRegCd}</td>
                        <td>${record.actualHr}</td>
                        <td>${record.taskBarcode}</td>
                        <td>${taskDescHtml}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            selectedDataContainer.innerHTML = html;
            
            // 統計包含"DD"字眼的紀錄數量
            const ddCount = countDDRecords();
            ddCountElement.textContent = ddCount;
            statsContainer.classList.remove('hidden');
            
            // 為表格行添加點擊事件
            const tableRows = selectedDataContainer.querySelectorAll('tbody tr');
            tableRows.forEach(row => {
                row.addEventListener('click', function() {
                    const date = this.dataset.date;
                    if (confirm(`是否要重新選擇 ${formatDateDisplay(date)} 的資料？`)) {
                        // 找到該日期在日期列表中的索引
                        const index = dates.indexOf(date);
                        if (index !== -1) {
                            // 返回選擇畫面
                            resultSection.classList.add('hidden');
                            selectionSection.classList.remove('hidden');
                            
                            // 導航到該日期
                            currentDateIndex = index;
                            displayRecordsForDate(date);
                            updateDateNavigation();
                            updateCalendar();
                        }
                    }
                });
            });
            
            // 切換到結果區
            selectionSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
        }

        // 下載Excel
        function downloadExcel() {
            const allSelections = Array.from(selectedData.values());
            if (allSelections.length === 0) {
                alert('沒有資料可以下載');
                return;
            }
            
            // 準備工作表資料
            const wsData = [
                ['日期', '時間', '機號', '實際工時', '任務條碼', '任務描述']
            ];
            
            // 按日期排序
            allSelections.sort((a, b) => a.date.localeCompare(b.date));
            
            allSelections.forEach(record => {
                // 使用原始任務描述
                const taskDesc = record.rawTaskDesc || record.taskDesc || '';
                
                wsData.push([
                    formatDateDisplay(record.date),
                    record.time,
                    record.acRegCd,
                    record.actualHr,
                    record.taskBarcode,
                    taskDesc
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '選擇的資料');
            
            // 生成檔名：使用最早和最晚的日期
            const sortedDates = allSelections.map(r => r.date).sort();
            const startDate = sortedDates[0];
            const endDate = sortedDates[sortedDates.length - 1];
            
            // 轉換為年月格式：YYYYMM
            const startDateStr = startDate.replace(/-/g, '').substring(0, 6);
            const endDateStr = endDate.replace(/-/g, '').substring(0, 6);
            
            const fileName = `${startDateStr}-${endDateStr}工作經歷.xlsx`;
            
            // 下載檔案
            XLSX.writeFile(wb, fileName);
        }

        // 下載CSV
        function downloadCSV() {
            const allSelections = Array.from(selectedData.values());
            if (allSelections.length === 0) {
                alert('沒有資料可以下載');
                return;
            }
            
            // 建立CSV內容
            let csvContent = '日期,時間,機號,實際工時,任務條碼,任務描述\n';
            
            // 按日期排序
            allSelections.sort((a, b) => a.date.localeCompare(b.date));
            
            allSelections.forEach(record => {
                // 使用原始任務描述
                const taskDesc = record.rawTaskDesc || record.taskDesc || '';
                
                csvContent += `"${formatDateDisplay(record.date)}","${record.time}","${record.acRegCd}","${record.actualHr}","${record.taskBarcode}","${taskDesc}"\n`;
            });
            
            // 生成檔名
            const sortedDates = allSelections.map(r => r.date).sort();
            const startDate = sortedDates[0];
            const endDate = sortedDates[sortedDates.length - 1];
            const startDateStr = startDate.replace(/-/g, '').substring(0, 6);
            const endDateStr = endDate.replace(/-/g, '').substring(0, 6);
            const fileName = `${startDateStr}-${endDateStr}工作經歷.csv`;
            
            // 建立下載連結
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }

        // 複製到剪貼簿
        function copyToClipboard() {
            const allSelections = Array.from(selectedData.values());
            if (allSelections.length === 0) {
                alert('沒有資料可以複製');
                return;
            }
            
            // 建立文字內容
            let textContent = '日期\t時間\t機號\t實際工時\t任務條碼\t任務描述\n';
            
            // 按日期排序
            allSelections.sort((a, b) => a.date.localeCompare(b.date));
            
            allSelections.forEach(record => {
                // 使用原始任務描述
                const taskDesc = record.rawTaskDesc || record.taskDesc || '';
                
                textContent += `${formatDateDisplay(record.date)}\t${record.time}\t${record.acRegCd}\t${record.actualHr}\t${record.taskBarcode}\t${taskDesc}\n`;
            });
            
            // 複製到剪貼簿
            navigator.clipboard.writeText(textContent)
                .then(() => alert('已複製到剪貼簿！'))
                .catch(err => alert('複製失敗: ' + err));
        }

        // 返回選擇畫面
        function backToSelection() {
            resultSection.classList.add('hidden');
            selectionSection.classList.remove('hidden');
        }

        // 重置選擇（不清除原始資料）
        function resetSelections() {
            if (confirm('確定要重新選擇嗎？所有已選擇的資料將會遺失。')) {
                selectedData.clear();
                currentDateIndex = 0;
                
                if (dates.length > 0) {
                    displayRecordsForDate(dates[0]);
                    updateDateNavigation();
                    updateCalendar();
                }
                
                updateSelectionProgress();
            }
        }

        // 更新選擇進度
        function updateSelectionProgress() {
            selectedCountElement.textContent = selectedData.size;
            
            if (selectedData.size === dates.length && dates.length > 0) {
                completionStatus.classList.remove('hidden');
            } else {
                completionStatus.classList.add('hidden');
            }
        }

        // 檢查是否完成所有選擇
        function checkCompletion() {
            updateSelectionProgress();
            
            if (selectedData.size === dates.length && dates.length > 0) {
                setTimeout(() => {
                    if (confirm('所有日期都已選擇完成！是否要顯示結果？')) {
                        exportSelectedData();
                    }
                }, 500);
            }
        }

        // 格式化日期顯示
        function formatDateDisplay(dateStr) {
            const date = parseDateString(dateStr);
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        }

        // 顯示載入中
        function showLoading(message) {
            recordsContainer.innerHTML = `<div class="loading">${message}</div>`;
        }

        // 顯示錯誤
        function showError(message) {
            recordsContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        // 初始化日期過濾器
        function initializeDateFilter() {
            const today = new Date();
            dateFilter.value = today.toISOString().split('T')[0];
            dateFilter.min = '2023-01-01';
            dateFilter.max = '2025-12-31';
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', initializeDateFilter);
    </script>
</body>
</html>
